import{_ as s,c as i,o as a,a3 as h}from"./chunks/framework.DpzXWsSh.js";const c=JSON.parse('{"title":"解决轻量云主机SSH连接超时问题及DNS配置优化","description":"","frontmatter":{"title":"解决轻量云主机SSH连接超时问题及DNS配置优化","date":"2024-9-25","categories":["踩坑","网络"]},"headers":[],"relativePath":"blogs/word/2024/20240925.md","filePath":"blogs/word/2024/20240925.md"}'),n={name:"blogs/word/2024/20240925.md"},t=h(`<p>在日常运维工作中，我们偶尔会遇到云主机SSH连接超时的情况。本文将详细介绍如何诊断和解决SSH连接超时问题，并分享一个关于DNS配置优化的小技巧。</p><h2 id="背景" tabindex="-1">背景 <a class="header-anchor" href="#背景" aria-label="Permalink to &quot;背景&quot;">​</a></h2><p>最近，我们在管理一台京东云的轻量云主机时遇到了SSH连接超时的情况，同时还伴随着ping命令超时的问题。唯一可以正常连接的方式是通过VNC远程桌面连接。接下来，我们将逐步解决这些问题。</p><h2 id="解决ping超时问题" tabindex="-1">解决ping超时问题 <a class="header-anchor" href="#解决ping超时问题" aria-label="Permalink to &quot;解决ping超时问题&quot;">​</a></h2><p>首先，我们需要解决ping超时的问题。ping命令可以帮助我们检测网络连通性，如果ping不通，那么SSH连接也无法建立。</p><h3 id="诊断与解决" tabindex="-1">诊断与解决 <a class="header-anchor" href="#诊断与解决" aria-label="Permalink to &quot;诊断与解决&quot;">​</a></h3><ol><li><p><strong>检查防火墙规则</strong>：我们首先检查了云主机的防火墙配置。发现虽然已经开放了SSH端口（TCP 22），但ping（ICMP协议）仍无法通过。</p></li><li><p><strong>开放ICMP协议</strong>：我们在防火墙中添加了允许ICMP协议的规则。</p></li></ol><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ufw</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> allow</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> icmp</span></span></code></pre></div><p>完成上述操作后，我们再次尝试ping主机，这次成功收到了回应，表明ICMP协议已经可以正常通过防火墙。</p><h2 id="解决ssh超时问题" tabindex="-1">解决ssh超时问题 <a class="header-anchor" href="#解决ssh超时问题" aria-label="Permalink to &quot;解决ssh超时问题&quot;">​</a></h2><p>尽管ping命令已经正常，但SSH连接仍然超时。我们需要进一步排查SSH服务的状态。</p><h3 id="诊断与解决-1" tabindex="-1">诊断与解决 <a class="header-anchor" href="#诊断与解决-1" aria-label="Permalink to &quot;诊断与解决&quot;">​</a></h3><ol><li><strong>检查SSH服务状态</strong>：通过VNC远程桌面连接到云主机，我们使用命令检查SSH服务的状态。</li></ol><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sshd</span></span></code></pre></div><p>输出结果显示SSH服务正在运行，并且正在监听所有IPv4和IPv6接口上的端口22。</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Loaded:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> loaded</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (/lib/systemd/system/ssh.service; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vendor</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> preset:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Active:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> active</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (running) since Wed 2024-09-25 10:58:04 CST; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">15min</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ago</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Main</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PID:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 767</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (sshd)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Tasks:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (limit: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2233</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Memory:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 3.7M</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CPU:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 29ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CGroup:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /system.slice/ssh.service</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        └─767</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sshd:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/sbin/sshd</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -D</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [listener] 0 of 10-100 startups</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Sep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 25</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10:58:04</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> lavm-vsxvt1r8be</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemd[1]:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Starting</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> OpenBSD</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Secure</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> shell</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> server...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Sep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 25</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10:58:04</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> lavm-vsxvt1r8be</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sshd[767]:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Server</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> listening</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.0.0.0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> port</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 22.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Sep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 25</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10:58:04</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> lavm-vsxvt1r8be</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sshd[767]:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Server</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> listening</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ::</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> port</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 22.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Sep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 25</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10:58:04</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> lavm-vsxvt1r8be</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemd[1]:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Started</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> OpenBSD</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Secure</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> shell</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> server.</span></span></code></pre></div><ol start="2"><li><strong>检查防火墙规则</strong>：尽管SSH服务已经在运行，但我们还需要确认防火墙是否允许通过SSH端口（TCP 22）的流量。</li></ol><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ufw</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> allow</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 22/tcp</span></span></code></pre></div><ol start="3"><li><strong>测试SSH连接</strong>：重新配置防火墙后，我们再次尝试通过SSH连接主机，这次成功连接上了</li></ol><p>通过上述步骤，我们解决了SSH连接超时的问题。</p><h2 id="解决下载包超时问题" tabindex="-1">解决下载包超时问题 <a class="header-anchor" href="#解决下载包超时问题" aria-label="Permalink to &quot;解决下载包超时问题&quot;">​</a></h2><p>在处理完SSH连接问题后，我们发现使用 <code>apt update</code> 命令下载包时依然存在超时现象。我们需要检查DNS配置是否正确。</p><h3 id="诊断与解决-2" tabindex="-1">诊断与解决 <a class="header-anchor" href="#诊断与解决-2" aria-label="Permalink to &quot;诊断与解决&quot;">​</a></h3><ol><li><strong>检查DNS配置</strong>：我们查看了/etc/resolv.conf文件，发现默认的DNS服务器是127.0.0.53，这是systemd-resolved服务的本地DNS代理地址。</li></ol><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/resolv.conf</span></span></code></pre></div><p>输出结果如下：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nameserver</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 127.0.0.53</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">options</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> edns0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> trust-ad</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">search</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .</span></span></code></pre></div><ol start="2"><li><strong>修改DNS服务器</strong>：我们决定将DNS服务器改为更稳定的公共DNS服务器，如Google的8.8.8.8以及云服务商提供的169.254.169.240。</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nano</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/resolv.conf</span></span></code></pre></div><p>修改后的文件内容如下：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nameserver</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 169.254.169.240</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nameserver</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8.8.8.8</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">options</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> edns0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> trust-ad</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">search</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .</span></span></code></pre></div><ol start="3"><li><strong>测试下载</strong>：修改DNS配置后，我们再次尝试运行 <code>apt update</code> 命令，这次成功更新了包列表，没有再出现超时问题。</li></ol>`,32),l=[t];function p(e,k,F,r,d,g){return a(),i("div",null,l)}const C=s(n,[["render",p]]);export{c as __pageData,C as default};
